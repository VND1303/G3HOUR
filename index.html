<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golden Hour v3.0 (Neon)</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de SunCalc.js (para calcular la posici√≥n del sol) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
    <!-- Fuentes: Inter (UI) y Roboto Mono (Datos) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Fondo inspirado en ARC Raiders */
            background-color: #0f0a1e; 
            background-image: linear-gradient(to bottom, #1a103c, #111827);
            color: #f3f4f6;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Fuentes de datos (estilo terminal) */
        .data-font {
            font-family: 'Roboto Mono', monospace;
        }
        
        /* Estilos de las pantallas */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.3s ease;
        }
        .hidden {
            display: none;
            opacity: 0;
        }

        /* --- Estilos de la Calculadora --- */
        #calculator-screen {
            background: transparent;
            overflow-y: auto;
            padding: 1.5rem;
        }
        
        /* Tarjetas de informaci√≥n */
        .info-card {
            background-color: #1f2937; /* bg-gray-800 */
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            border: 1px solid;
        }
        .info-card h3 {
            font-size: 0.9rem;
            font-weight: 500;
            color: #9ca3af; /* text-gray-400 */
            text-transform: uppercase;
        }
        .info-card .time {
            font-size: 1.75rem;
            font-weight: 700;
            color: #ffffff;
            line-height: 1.2;
        }
        .info-card .detail {
            font-size: 0.9rem;
            color: #d1d5db; /* text-gray-300 */
        }
        
        /* Colores de las tarjetas (Ne√≥n) */
        .card-sunrise { border-color: #fdba74; }
        .card-sunset { border-color: #f0abfc; }
        .card-solar-noon { border-color: #fde047; }
        .card-golden-hour { border-color: #fcd34d; }
        .card-blue-hour { border-color: #93c5fd; }
        .card-advice { border-color: #6b7280; }

        /* L√≠nea de tiempo */
        #timeline-container {
            position: relative;
        }
        #timeline {
            display: flex;
            width: 100%;
            height: 2.5rem; /* 40px */
            border-radius: 99px;
            overflow: hidden;
            background-color: #1f2937;
            border: 2px solid #374151;
            font-size: 0.75rem;
            font-weight: 600;
            color: #111827;
        }
        .timeline-segment {
            display: grid;
            place-items: center;
            height: 100%;
            overflow: hidden;
            white-space: nowrap;
        }
        /* Marcador "Ahora" */
        #timeline-marker {
            position: absolute;
            top: -5px;
            bottom: -5px;
            width: 3px;
            background-color: #f000b0; /* Ne√≥n Pink */
            box-shadow: 0 0 5px #f000b0, 0 0 10px #f000b0;
            z-index: 10;
            border-radius: 2px;
            display: none; /* Oculto por defecto */
            transition: left 0.5s linear;
        }
        
        /* Botones Ne√≥n */
        .neon-button {
            background-color: rgba(0, 240, 255, 0.1);
            border: 1px solid #00f0ff;
            color: #00f0ff;
            box-shadow: 0 0 5px #00f0ff, 0 0 10px #00f0ff;
            transition: all 0.3s ease;
        }
        .neon-button:hover, .neon-button.active {
            background-color: #00f0ff;
            color: #111827;
            box-shadow: 0 0 10px #00f0ff, 0 0 20px #00f0ff;
        }
        
        /* Bot√≥n de fecha */
        #date-picker {
            background: #1f2937;
            color: white;
            border: 1px solid #374151;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        /* --- Estilos de la C√°mara AR --- */
        #ar-screen { background-color: #000; }
        #camera-feed {
            position: absolute; top: 50%; left: 50%;
            width: auto; height: auto;
            min-width: 100%; min-height: 100%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        #ar-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; overflow: hidden;
        }
        .sun-marker-base {
            width: 60px; height: 60px;
            border-radius: 50%;
            position: absolute;
            z-index: 30;
            font-size: 30px;
            display: grid;
            place-items: center;
            transition: transform 0.1s linear, bottom 0.5s linear;
            left: 50%; /* Centrado horizontalmente */
        }
        #sun-marker-now {
            background-color: rgba(251, 191, 36, 0.7); /* Amarillo */
            border: 4px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px #fde047, 0 0 25px #fde047;
        }
        #sun-marker-sunrise {
            background-color: rgba(253, 186, 116, 0.5); /* Naranja p√°lido */
            border: 2px dashed rgba(255, 255, 255, 0.5);
        }
        #sun-marker-sunset {
            background-color: rgba(239, 68, 68, 0.5); /* Rojo p√°lido */
            border: 2px dashed rgba(255, 255, 255, 0.5);
        }
        
        #debug-info {
            position: absolute; bottom: 20px; left: 20px; z-index: 50;
            color: white; font-family: 'Roboto Mono', monospace;
            background-color: rgba(0,0,0,0.5); padding: 5px; border-radius: 5px;
        }
        #btn-close-ar {
            position: absolute; top: 1.5rem; left: 1.5rem; z-index: 50;
            background-color: rgba(0,0,0,0.5); color: white;
            border: 1px solid rgba(255,255,255,0.7);
            border-radius: 99px; padding: 0.5rem 1rem;
            font-weight: 600; backdrop-filter: blur(5px);
        }
        
    </style>
</head>
<body>

    <!-- PANTALLA 1: CARGA INICIAL Y PERMISO DE GPS -->
    <div id="loading-screen" class="screen" style="display: grid; place-items: center; text-align: center; background: #0f0a1e; z-index: 200; padding: 1rem;">
        <div>
            <h1 class="text-4xl font-extrabold text-white mb-4">Golden Hour <span class="text-blue-400">v3.0</span></h1>
            <p id="loading-status" class="text-xl text-yellow-400">Detectando tu ubicaci√≥n (GPS/Red)...</p>
            
            <!-- Fallback por si el GPS falla -->
            <div id="manual-search" class="hidden mt-6 max-w-sm mx-auto">
                <p class="text-red-400 mb-4">No se pudo obtener la ubicaci√≥n.</p>
                <label for="location-search" class="text-gray-300">Buscar ubicaci√≥n manualmente:</label>
                <input type="text" id="location-search" placeholder="Ej: Tepic, M√©xico" class="w-full mt-2 p-3 rounded bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="search-button" class="w-full mt-2 p-3 bg-blue-600 rounded font-bold text-lg hover:bg-blue-500">Buscar</button>
            </div>
        </div>
    </div>

    <!-- PANTALLA 2: APLICACI√ìN PRINCIPAL (CALCULADORA + AR) -->
    <div id="main-app" class="hidden">
        
        <!-- PANTALLA DE CALCULADORA -->
        <div id="calculator-screen" class="screen" style="position: relative;">
            <div class="max-w-2xl mx-auto space-y-6">
                
                <!-- Encabezado -->
                <header class="text-center space-y-2 pt-6">
                    <h1 class="text-4xl font-extrabold text-white">Golden Hour</h1>
                    <p id="location-name" class="text-xl font-medium text-blue-300">Tepic, M√©xico</p>
                </header>
                
                <!-- Selector de Fecha -->
                <section class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <div class="flex flex-wrap justify-center items-center gap-3">
                        <button class="date-button neon-button py-2 px-4 rounded-lg font-semibold" data-days="0">Hoy</button>
                        <button class="date-button neon-button py-2 px-4 rounded-lg font-semibold" data-days="1">Ma√±ana</button>
                        <button class="date-button neon-button py-2 px-4 rounded-lg font-semibold" data-days="3">En 3 D√≠as</button>
                        <input type="date" id="date-picker" class="py-2">
                    </div>
                    <p id="current-date-display" class="text-lg text-center font-bold text-gray-400 mt-3 data-font">Lunes, 17 de Noviembre de 2025</p>
                </section>
                
                <!-- Bot√≥n para modo AR -->
                <button id="btn-open-ar" class="w-full py-3 px-6 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-md transition duration-300 flex items-center justify-center neon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mr-2" viewBox="0 0 16 16"><path d="M8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8z"/></svg>
                    Modo Br√∫jula AR (Mostrar Sol)
                </button>
                
                <!-- L√≠nea de Tiempo -->
                <section>
                    <h2 class="text-xl font-bold text-white mb-3">L√≠nea de Tiempo del D√≠a</h2>
                    <div id="timeline-container">
                        <div id="timeline-marker"></div>
                        <div id="timeline">
                            <!-- Se genera con JS -->
                        </div>
                    </div>
                </section>
                
                <!-- Informaci√≥n Detallada -->
                <section>
                    <h2 class="text-xl font-bold text-white mb-3">Informaci√≥n Detallada</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="info-card card-sunrise"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2L12 5M12 19L12 22M4.22 4.22L6.34 6.34M17.66 17.66L19.78 19.78M2 12L5 12M19 12L22 12M4.22 19.78L6.34 17.66M17.66 6.34L19.78 4.22M2 16H22M5 22L19 22"></path></svg>
                            <div><h3>Amanecer</h3><p id="sunrise-time" class="time data-font">06:12</p><p id="sunrise-day" class="detail data-font">Domingo</p></div></div>
                        <div class="info-card card-sunset"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2L12 5M12 19L12 22M4.22 4.22L6.34 6.34M17.66 17.66L19.78 19.78M2 12L5 12M19 12L22 12M4.22 19.78L6.34 17.66M17.66 6.34L19.78 4.22M2 16H22M5 16L19 16"></path></svg>
                            <div><h3>Atardecer</h3><p id="sunset-time" class="time data-font">17:18</p><p id="sunset-day" class="detail data-font">Domingo</p></div></div>
                        <div class="info-card card-golden-hour"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                            <div><h3>Golden Hour Matutina</h3><p id="gh-morn-time" class="time data-font">06:12 - 06:15</p><p id="gh-morn-duration" class="detail data-font">2 min</p></div></div>
                        <div class="info-card card-golden-hour"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                            <div><h3>Golden Hour Vespertina</h3><p id="gh-eve-time" class="time data-font">17:15 - 17:18</p><p id="gh-eve-duration" class="detail data-font">2 min</p></div></div>
                        <div class="info-card card-blue-hour"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                            <div><h3>Blue Hour</h3><p id="bh-time" class="time data-font">Ma√±ana & Tarde</p><p id="bh-detail" class="detail data-font">05:49 & 17:18</p></div></div>
                        <div class="info-card card-solar-noon"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <div><h3>Mediod√≠a Solar</h3><p id="solar-noon-time" class="time data-font">11:45</p><p class="detail">Punto m√°s alto del sol</p></div></div>
                    </div>
                </section>
                
                <!-- Consejos de Fotograf√≠a -->
                <section class="pb-12">
                    <h2 class="text-xl font-bold text-white mb-3">Consejos de Fotograf√≠a</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="info-card card-advice"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <div><h3>Configuraci√≥n</h3><p class="detail">Usa ISO bajo (100-400), apertura f/5.6-f/11, y balance de blancos 'nublado'.</p></div></div>
                        <div class="info-card card-advice"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M4 13H3v-2h1v2zm17 0h-1v-2h1v2zM12 5a1 1 0 100-2 1 1 0 000 2zM5.636 19.364A9 9 0 1018.364 5.636 9 9 0 005.636 19.364z"></path></svg>
                            <div><h3>Mejor Momento</h3><p class="detail">Planifica 15-20 minutos antes. Los primeros y √∫ltimos 10 minutos ofrecen la luz m√°s dram√°tica.</p></div></div>
                    </div>
                </section>
            </div>
        </div>

        <!-- PANTALLA DE C√ÅMARA AR -->
        <div id="ar-screen" class="screen hidden" style="background-color: #000;">
            <video id="camera-feed" playsinline autoplay muted loop></video>
            <div id="ar-overlay">
                <!-- Marcadores de Trayectoria -->
                <div id="sun-marker-sunrise" class="sun-marker-base">üåÖ</div>
                <div id="sun-marker-sunset" class="sun-marker-base">üåá</div>
                <!-- Marcador del Sol Actual -->
                <div id="sun-marker-now" class="sun-marker-base">‚òÄÔ∏è</div>
            </div>
            <button id="btn-close-ar">‚Üê Volver a la Calculadora</button>
            <div id="debug-info">Activando br√∫jula...</div>
        </div>
    </div>

    <script>
        // --- Referencias DOM ---
        const loadingScreen = document.getElementById('loading-screen');
        const loadingStatus = document.getElementById('loading-status');
        const manualSearchUI = document.getElementById('manual-search');
        const searchButton = document.getElementById('search-button');
        const locationSearchInput = document.getElementById('location-search');
        const mainApp = document.getElementById('main-app');
        
        const calculatorScreen = document.getElementById('calculator-screen');
        const locationName = document.getElementById('location-name');
        const currentDateDisplay = document.getElementById('current-date-display');
        const timeline = document.getElementById('timeline');
        const timelineMarker = document.getElementById('timeline-marker');
        const btnOpenAr = document.getElementById('btn-open-ar');
        const datePicker = document.getElementById('date-picker');
        const dateButtons = document.querySelectorAll('.date-button');
        
        const arScreen = document.getElementById('ar-screen');
        const cameraFeed = document.getElementById('camera-feed');
        const arOverlay = document.getElementById('ar-overlay');
        const btnCloseAr = document.getElementById('btn-close-ar');
        const debugInfo = document.getElementById('debug-info');

        // --- Estado Global ---
        let currentPosition = { lat: 0, lon: 0 };
        let currentDate = new Date();
        let sunPositions = {}; // Almacena las posiciones AR
        let cameraStream = null;
        let nowMarkerInterval = null;

        // --- Formateadores ---
        const formatTime = (date) => date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        const formatDay = (date) => date.toLocaleDateString('es-ES', { weekday: 'long' });
        const formatDate = (date) => date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const formatYYYYMMDD = (date) => date.toISOString().split('T')[0];

        // --- 1. INICIO DE LA APP ---
        window.addEventListener('load', startApp);
        searchButton.addEventListener('click', handleManualSearch);
        
        async function startApp() {
            try {
                // 1. Obtener Ubicaci√≥n (Autom√°tico)
                loadingStatus.textContent = "Detectando tu ubicaci√≥n (GPS/Red)...";
                const position = await getGpsLocation();
                
                // 2. Obtener Nombre de la Ubicaci√≥n
                loadingStatus.textContent = "Identificando ubicaci√≥n...";
                const locName = await getReverseGeocode(position.coords.latitude, position.coords.longitude);
                
                // 3. Inicializar la App
                await initializeMainApp(position.coords.latitude, position.coords.longitude, locName);

            } catch (err) {
                let userMessage = "Ocurri√≥ un error desconocido.";
                if (err && err.code) {
                    switch (err.code) {
                        case 1: userMessage = "Permiso de ubicaci√≥n denegado."; break;
                        case 2: userMessage = "Ubicaci√≥n no disponible."; break;
                        case 3: userMessage = "El servicio de ubicaci√≥n tard√≥ demasiado."; break;
                    }
                } else if (err && err.message) { userMessage = err.message; }
                
                loadingStatus.textContent = `Error: ${userMessage}`;
                loadingStatus.style.color = '#f87171'; // text-red-400
                console.error("Error detallado en startApp:", err); 
                manualSearchUI.classList.remove('hidden');
            }
        }
        
        // --- 1.1 B√∫squeda Manual ---
        async function handleManualSearch() {
            const query = locationSearchInput.value;
            if (!query) return;
            
            try {
                loadingStatus.textContent = `Buscando "${query}"...`;
                loadingStatus.style.color = '#fde047'; // text-yellow
                manualSearchUI.classList.add('hidden');
                
                // 1. Geocodificar (Nombre -> Coordenadas)
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=jsonv2&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    const locName = result.display_name.split(',').slice(0, 2).join(', ');
                    
                    // 2. Inicializar la App
                    await initializeMainApp(lat, lon, locName);
                } else {
                    throw new Error("Ubicaci√≥n no encontrada.");
                }
            } catch (err) {
                loadingStatus.textContent = `Error: ${err.message}`;
                loadingStatus.style.color = '#f87171';
                manualSearchUI.classList.remove('hidden');
            }
        }
        
        // --- 1.2 Inicializador Principal ---
        async function initializeMainApp(lat, lon, locName) {
            currentPosition.lat = lat;
            currentPosition.lon = lon;
            locationName.textContent = locName;
            
            // Configurar Listeners de Fecha
            datePicker.addEventListener('change', handleDateChange);
            dateButtons.forEach(btn => btn.addEventListener('click', handleDateButton));
            
            // Actualizar c√°lculos
            updateAllCalculations(true); // true = es la carga inicial

            // Iniciar el marcador "Ahora"
            if (nowMarkerInterval) clearInterval(nowMarkerInterval);
            nowMarkerInterval = setInterval(updateNowMarker, 15000); // Cada 15 seg
            
            // Mostrar la app
            loadingScreen.style.display = 'none';
            mainApp.classList.remove('hidden');
        }

        // --- 2. Funciones de Carga de Datos y C√°lculo ---

        function getGpsLocation() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: false, 
                    timeout: 10000, 
                    maximumAge: 60000
                });
            });
        }
        
        async function getReverseGeocode(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                if (data.address) {
                    return `${data.address.city || data.address.town || 'Ubicaci√≥n'}, ${data.address.country}`;
                }
                return "Ubicaci√≥n Detectada";
            } catch (err) {
                console.warn("Error de geocodificaci√≥n, usando gen√©rico:", err);
                return "Ubicaci√≥n Detectada";
            }
        }

        // --- 3. Funciones de UI y Fecha (Calculadora) ---
        
        function handleDateButton(e) {
            const daysToAdd = parseInt(e.target.dataset.days, 10);
            const newDate = new Date();
            newDate.setDate(newDate.getDate() + daysToAdd);
            currentDate = newDate;
            
            datePicker.value = formatYYYYMMDD(currentDate);
            updateAllCalculations();
        }
        
        function handleDateChange(e) {
            // El input de fecha da un string "YYYY-MM-DD". 
            // Necesitamos convertirlo a un objeto Date
            // a√±adiendo 'T12:00:00' para evitar problemas de zona horaria.
            currentDate = new Date(e.target.value + 'T12:00:00');
            updateAllCalculations();
        }

        function updateAllCalculations(isInitialLoad = false) {
            // Actualizar fecha en UI
            currentDateDisplay.textContent = formatDate(currentDate);
            if(isInitialLoad) {
                datePicker.value = formatYYYYMMDD(currentDate);
            }
            
            // Actualizar botones activos
            updateActiveDateButton();
            
            // Calcular Tiempos Solares
            const sunTimes = SunCalc.getTimes(currentDate, currentPosition.lat, currentPosition.lon);
            
            // Poblar la UI
            populateCalculatorUI(sunTimes);
            buildTimeline(sunTimes);
            
            // Actualizar marcador "Ahora"
            updateNowMarker();
            
            // Pre-calcular posiciones AR para la br√∫jula
            calculateArPositions(sunTimes);
        }

        function populateCalculatorUI(times) {
            document.getElementById('sunrise-time').textContent = formatTime(times.sunrise);
            document.getElementById('sunrise-day').textContent = formatDay(times.sunrise);
            document.getElementById('sunset-time').textContent = formatTime(times.sunset);
            document.getElementById('sunset-day').textContent = formatDay(times.sunset);
            document.getElementById('solar-noon-time').textContent = formatTime(times.solarNoon);

            const ghMornStart = formatTime(times.goldenHourEnd); 
            const ghMornEnd = formatTime(times.sunrise);
            const ghEveStart = formatTime(times.sunset);
            const ghEveEnd = formatTime(times.goldenHour); 
            const ghMornDuration = Math.round((times.sunrise - times.goldenHourEnd) / 60000);
            const ghEveDuration = Math.round((times.goldenHour - times.sunset) / 60000);

            document.getElementById('gh-morn-time').textContent = `${ghMornStart} - ${ghMornEnd}`;
            document.getElementById('gh-morn-duration').textContent = `${ghMornDuration} min`;
            document.getElementById('gh-eve-time').textContent = `${ghEveStart} - ${ghEveEnd}`;
            document.getElementById('gh-eve-duration').textContent = `${ghEveDuration} min`;
            
            const bhMornStart = formatTime(times.nauticalDawn);
            const bhEveEnd = formatTime(times.nauticalDusk);
            document.getElementById('bh-detail').textContent = `${bhMornStart} & ${bhEveEnd}`;
        }
        
        function buildTimeline(times) {
            const toMin = (date) => date.getHours() * 60 + date.getMinutes();
            const nightStart = 0, blueHourMornStart = toMin(times.nauticalDawn), goldenHourMornStart = toMin(times.goldenHourEnd), dayStart = toMin(times.sunrise);
            const dayEnd = toMin(times.sunset), goldenHourEveEnd = toMin(times.goldenHour), blueHourEveEnd = toMin(times.nauticalDusk), nightEnd = 1440;

            const periods = [
                { name: 'Noche', duration: blueHourMornStart, color: '#0f172a', text: 'Noche' },
                { name: 'Blue Hour Ma√±ana', duration: goldenHourMornStart - blueHourMornStart, color: '#60a5fa', text: 'B...' },
                { name: 'Golden Hour Ma√±ana', duration: dayStart - goldenHourMornStart, color: '#fcd34d', text: 'G...' },
                { name: 'D√≠a', duration: dayEnd - dayStart, color: '#93c5fd', text: 'D√≠a' },
                { name: 'Golden Hour Tarde', duration: goldenHourEveEnd - dayEnd, color: '#fcd34d', text: 'G...' },
                { name: 'Blue Hour Tarde', duration: blueHourEveEnd - goldenHourEveEnd, color: '#60a5fa', text: 'B...' },
                { name: 'Noche', duration: nightEnd - blueHourEveEnd, color: '#0f172a', text: 'Noche' }
            ];
            
            timeline.innerHTML = '';
            periods.forEach(p => {
                const percentage = (p.duration / nightEnd) * 100;
                if (percentage < 3) return; 
                
                const segment = document.createElement('div');
                segment.className = 'timeline-segment';
                segment.style.width = `${percentage}%`;
                segment.style.backgroundColor = p.color;
                segment.style.color = (p.color === '#93c5fd' || p.color === '#fcd34d') ? '#1e293b' : '#e2e8f0';
                segment.textContent = p.text;
                segment.title = `${p.name} (${p.duration} min)`;
                timeline.appendChild(segment);
            });
        }
        
        function updateNowMarker() {
            const now = new Date();
            const isToday = now.toDateString() === currentDate.toDateString();
            
            if (isToday) {
                const minutes = now.getHours() * 60 + now.getMinutes();
                const perc = (minutes / 1440) * 100;
                timelineMarker.style.display = 'block';
                timelineMarker.style.left = `${perc}%`;
            } else {
                timelineMarker.style.display = 'none';
            }
        }
        
        function updateActiveDateButton() {
            const today = new Date();
            dateButtons.forEach(btn => {
                const daysToAdd = parseInt(btn.dataset.days, 10);
                const btnDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() + daysToAdd);
                if (btnDate.toDateString() === currentDate.toDateString()) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // --- 4. Funciones de Navegaci√≥n y AR ---
        
        btnOpenAr.addEventListener('click', startArMode);
        btnCloseAr.addEventListener('click', stopArMode);

        async function startArMode() {
            try {
                calculatorScreen.classList.add('hidden');
                arScreen.classList.remove('hidden');
                
                debugInfo.textContent = "Activando c√°mara...";
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                cameraFeed.srcObject = stream;
                cameraStream = stream; 
                await cameraFeed.play();
                
                debugInfo.textContent = "Activando br√∫jula...";
                await requestMotionPermission();
                window.addEventListener('deviceorientation', handleOrientation);
                
            } catch (err) {
                debugInfo.textContent = `Error AR: ${err.message}`;
                setTimeout(stopArMode, 2000); 
            }
        }
        
        function stopArMode() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            window.removeEventListener('deviceorientation', handleOrientation);
            arScreen.classList.add('hidden');
            calculatorScreen.classList.remove('hidden');
        }

        function requestMotionPermission() {
            return new Promise((resolve, reject) => {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(state => (state === 'granted') ? resolve() : reject(new Error('Permiso de movimiento denegado.')))
                        .catch(reject);
                } else {
                    resolve();
                }
            });
        }
        
        // --- 4.1 L√≥gica de AR v3.0 (Trayectoria) ---
        
        function calculateArPositions(sunTimes) {
            // Almacenar las posiciones de azimut y altitud para los 3 puntos clave
            const posNow = SunCalc.getPosition(currentDate, currentPosition.lat, currentPosition.lon);
            const posSunrise = SunCalc.getPosition(sunTimes.sunrise, currentPosition.lat, currentPosition.lon);
            const posSunset = SunCalc.getPosition(sunTimes.sunset, currentPosition.lat, currentPosition.lon);
            
            const toDeg = (rad) => (rad * 180 / Math.PI);
            const toAzimuth = (rad) => {
                let deg = toDeg(rad) + 180;
                if (deg >= 360) deg -= 360;
                return deg;
            };
            const toAltitude = (rad) => toDeg(rad);

            sunPositions = {
                now: { azimuth: toAzimuth(posNow.azimuth), altitude: toAltitude(posNow.altitude) },
                sunrise: { azimuth: toAzimuth(posSunrise.azimuth), altitude: toAltitude(posSunrise.altitude) },
                sunset: { azimuth: toAzimuth(posSunset.azimuth), altitude: toAltitude(posSunset.altitude) }
            };
            
            // Posicionar altitud est√°tica de amanecer/atardecer (est√°n en el horizonte)
            document.getElementById('sun-marker-sunrise').style.bottom = '-30px'; // -30px para centrar
            document.getElementById('sun-marker-sunset').style.bottom = '-30px';
        }

        function handleOrientation(event) {
            let deviceAlpha = event.alpha || event.webkitCompassHeading;
            if (deviceAlpha === null) return;
            
            // Actualizar el sol "Ahora" (el √∫nico que cambia de altitud)
            const posNow = SunCalc.getPosition(new Date(), currentPosition.lat, currentPosition.lon);
            const altNow = (posNow.altitude * 180 / Math.PI);
            sunPositions.now.altitude = altNow;
            
            // Aplicar posiciones a los 3 marcadores
            updateMarkerPosition(document.getElementById('sun-marker-now'), sunPositions.now, deviceAlpha);
            updateMarkerPosition(document.getElementById('sun-marker-sunrise'), sunPositions.sunrise, deviceAlpha);
            updateMarkerPosition(document.getElementById('sun-marker-sunset'), sunPositions.sunset, deviceAlpha);
            
            debugInfo.textContent = `Br√∫jula: ${deviceAlpha.toFixed(1)}¬∞ | Az(Ahora): ${sunPositions.now.azimuth.toFixed(1)}¬∞`;
        }
        
        function updateMarkerPosition(marker, sunPos, deviceAlpha) {
            // 1. Posici√≥n Horizontal (X)
            let delta = sunPos.azimuth - deviceAlpha;
            if (delta > 180) { delta -= 360; }
            if (delta < -180) { delta += 360; }
            
            // Mapear grados a p√≠xeles (10px por grado de FOV)
            const horizontalPosition = `calc(-50% + ${delta * 10}px)`;

            // 2. Posici√≥n Vertical (Y)
            const verticalPosition = (sunPos.altitude / 90) * 100;
            
            // Aplicar estilos
            marker.style.transform = `translateX(${horizontalPosition})`;
            if(marker.id !== 'sun-marker-sunrise' && marker.id !== 'sun-marker-sunset') {
                marker.style.bottom = `calc(${verticalPosition}% - 30px)`;
            }
        }

    </script>
</body>
</html>
